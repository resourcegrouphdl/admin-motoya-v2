<div class="documentacion-legal-container">
  <!-- ========================================== -->
  <!-- HEADER DE DOCUMENTACIÓN LEGAL -->
  <!-- ========================================== -->
  <div class="documentacion-header mb-4">
    <mat-card class="header-card">
      <mat-card-header>
        <div mat-card-avatar class="avatar-documentacion">
          <mat-icon>description</mat-icon>
        </div>

        <mat-card-title>
          <div class="title-container">
            <h2>Documentación Legal</h2>
            <div class="subtitle-info">
              <mat-chip
                [color]="porcentajeCompletitud >= 100 ? 'primary' : 'accent'"
                selected
              >
                {{ documentosGenerados }}/{{
                  totalDocumentosObligatorios
                }}
                Documentos Generados
              </mat-chip>

              <mat-chip color="primary" selected>
                <mat-icon matChipAvatar>assessment</mat-icon>
                {{ porcentajeCompletitud }}% Completado
              </mat-chip>

              <mat-chip *ngIf="documentosPendientes > 0" color="warn" selected>
                {{ documentosPendientes }} Pendientes
              </mat-chip>
            </div>
          </div>
        </mat-card-title>

        <div class="header-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="generarTodosDocumentos()"
            [disabled]="documentosPendientes === 0"
          >
            <mat-icon>auto_awesome</mat-icon>
            Generar Todos
          </button>

          <button
            mat-button
            (click)="exportarPaqueteCompleto()"
            [disabled]="documentosGenerados === 0"
          >
            <mat-icon>archive</mat-icon>
            Exportar Paquete
          </button>

          <button
            mat-icon-button
            (click)="toggleConfiguracion()"
            matTooltip="Configuración"
          >
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Progreso General -->
        <div class="progreso-general">
          <div class="progreso-info">
            <span class="progreso-label">Progreso de Documentación</span>
            <span class="progreso-porcentaje"
              >{{ porcentajeCompletitud }}%</span
            >
          </div>
          <mat-progress-bar
            [value]="porcentajeCompletitud"
            [color]="porcentajeCompletitud >= 100 ? 'primary' : 'accent'"
            class="progreso-bar"
          >
          </mat-progress-bar>

          <!-- Resumen de Estados -->
          <div class="resumen-estados">
            <div class="estado-item">
              <mat-icon color="primary">check_circle</mat-icon>
              <span
                >{{
                  contarDocumentosPorEstado("generado") +
                    contarDocumentosPorEstado("firmado")
                }}
                Completados</span
              >
            </div>
            <div class="estado-item">
              <mat-icon color="accent">schedule</mat-icon>
              <span
                >{{ contarDocumentosPorEstado("pendiente") }} Pendientes</span
              >
            </div>
            <div
              class="estado-item"
              *ngIf="contarDocumentosPorEstado('generando') > 0"
            >
              <mat-icon color="primary">hourglass_empty</mat-icon>
              <span
                >{{ contarDocumentosPorEstado("generando") }} Generando</span
              >
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ========================================== -->
  <!-- CONFIGURACIÓN (EXPANDIBLE) -->
  <!-- ========================================== -->
  <div class="configuracion-panel mb-4" *ngIf="mostrarConfiguracion">
    <mat-card class="configuracion-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="primary">settings</mat-icon>
          Configuración de Documentos
        </mat-card-title>
        <mat-card-subtitle>
          Configure los parámetros para la generación de documentos
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="formularioConfiguracion" class="configuracion-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Formato de Papel</mat-label>
              <mat-select formControlName="formatoPapel">
                <mat-option value="A4">A4</mat-option>
                <mat-option value="Legal">Legal</mat-option>
                <mat-option value="Carta">Carta</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Orientación</mat-label>
              <mat-select formControlName="orientacion">
                <mat-option value="portrait">Vertical</mat-option>
                <mat-option value="landscape">Horizontal</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo de Firma</mat-label>
              <mat-select formControlName="tipoFirma">
                <mat-option value="digital">Digital</mat-option>
                <mat-option value="manuscrita">Manuscrita</mat-option>
                <mat-option value="ambas">Ambas</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Número de Copias</mat-label>
              <input
                matInput
                type="number"
                formControlName="copias"
                min="1"
                max="10"
              />
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-checkbox formControlName="incluirLogos">
              Incluir logotipos oficiales
            </mat-checkbox>

            <mat-checkbox formControlName="requiereNotarizacion">
              Requiere notarización
            </mat-checkbox>
          </div>
        </form>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button (click)="toggleConfiguracion()">Cerrar</button>
        <button mat-raised-button color="primary">Guardar Configuración</button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- ========================================== -->
  <!-- SECCIONES EXPANDIBLES -->
  <!-- ========================================== -->
  <div class="secciones-documentacion">
    <!-- Sección: Documentos Legales -->
    <mat-expansion-panel
      [expanded]="estaSeccionExpandida('documentos')"
      (opened)="expandirSeccion('documentos')"
    >
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon color="primary">folder</mat-icon>
          <span class="ml-2">Documentos Legales</span>
        </mat-panel-title>
        <mat-panel-description>
          <mat-chip color="primary" selected>
            {{ documentosLegales.length }} documentos
          </mat-chip>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="seccion-content">
        <div class="documentos-grid">
          <mat-card
            *ngFor="let documento of documentosLegales"
            class="documento-card"
            [ngClass]="'documento-' + documento.estado"
          >
            <mat-card-header>
              <div
                mat-card-avatar
                class="avatar-documento"
                [ngClass]="'avatar-' + documento.estado"
              >
                <mat-icon [color]="obtenerColorDocumento(documento.tipo)">
                  {{ obtenerIconoDocumento(documento.tipo) }}
                </mat-icon>
              </div>

              <mat-card-title>{{ documento.nombre }}</mat-card-title>
              <mat-card-subtitle>
                {{ documento.descripcion }}
                <div class="documento-badges">
                  <mat-chip
                    [color]="obtenerColorEstado(documento.estado)"
                    selected
                    class="estado-chip"
                  >
                    {{ documento.estado | titlecase }}
                  </mat-chip>
                  <mat-chip
                    *ngIf="documento.esObligatorio"
                    color="accent"
                    selected
                  >
                    Obligatorio
                  </mat-chip>
                  <mat-chip
                    *ngIf="documento.requiereFirma"
                    color="primary"
                    selected
                  >
                    Requiere Firma
                  </mat-chip>
                </div>
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <!-- Información del documento -->
              <div class="documento-info">
                <div class="info-item" *ngIf="documento.fechaGeneracion">
                  <mat-icon>schedule</mat-icon>
                  <span
                    >Generado:
                    {{ formatearFecha(documento.fechaGeneracion) }}</span
                  >
                </div>

                <div class="info-item" *ngIf="documento.version > 1">
                  <mat-icon>history</mat-icon>
                  <span>Versión: {{ documento.version }}</span>
                </div>

                <div
                  class="info-item"
                  *ngIf="
                    documento.firmadoPor && documento.firmadoPor.length > 0
                  "
                >
                  <mat-icon>verified</mat-icon>
                  <span
                    >Firmado por: {{ documento.firmadoPor.join(", ") }}</span
                  >
                </div>
              </div>

              <!-- Dependencias -->
              <div
                class="dependencias"
                *ngIf="documento.dependeDe && documento.dependeDe.length > 0"
              >
                <span class="dependencias-label">Depende de:</span>
                <div class="dependencias-lista">
                  <mat-chip
                    *ngFor="let dep of documento.dependeDe"
                    [color]="obtenerColorEstado(obtenerEstadoDependencia(dep))"
                    class="dependencia-chip"
                  >
                    {{ obtenerNombreDependencia(dep) }}
                  </mat-chip>
                </div>
              </div>

              <!-- Progreso de generación -->
              <div
                class="progreso-documento"
                *ngIf="documento.estado === 'generando'"
              >
                <mat-progress-bar
                  mode="indeterminate"
                  color="primary"
                ></mat-progress-bar>
                <span class="progreso-texto">Generando documento...</span>
              </div>
            </mat-card-content>

            <mat-card-actions>
              <!-- Botón principal según el estado -->
              <button
                mat-raised-button
                [color]="obtenerColorDocumento(documento.tipo)"
                *ngIf="documento.estado === 'pendiente'"
                [disabled]="
                  !puedeGenerarDocumento(documento) || documentoGenerando !== ''
                "
                (click)="generarDocumento(documento)"
              >
                <mat-icon>create</mat-icon>
                Generar
              </button>

              <button
                mat-raised-button
                color="primary"
                *ngIf="requiereFirma(documento)"
                (click)="iniciarProcesoFirma(documento)"
              >
                <mat-icon>draw</mat-icon>
                Firmar
              </button>

              <!-- Acciones secundarias -->
              <div
                class="acciones-secundarias"
                *ngIf="
                  documento.estado === 'generado' ||
                  documento.estado === 'firmado'
                "
              >
                <button mat-button (click)="descargarDocumento(documento)">
                  <mat-icon>download</mat-icon>
                  Descargar
                </button>

                <button mat-button (click)="previsualizarDocumento(documento)">
                  <mat-icon>visibility</mat-icon>
                  Ver
                </button>

                <button mat-button [matMenuTriggerFor]="menuDocumento">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #menuDocumento="matMenu">
                  <button mat-menu-item (click)="enviarPorEmail(documento)">
                    <mat-icon>email</mat-icon>
                    Enviar por Email
                  </button>
                  <button mat-menu-item (click)="regenerarDocumento(documento)">
                    <mat-icon>refresh</mat-icon>
                    Regenerar
                  </button>
                </mat-menu>
              </div>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Sección: Cronograma de Generación -->
    <mat-expansion-panel
      [expanded]="estaSeccionExpandida('cronograma')"
      (opened)="expandirSeccion('cronograma')"
    >
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon color="accent">timeline</mat-icon>
          <span class="ml-2">Cronograma de Generación</span>
        </mat-panel-title>
        <mat-panel-description>
          <mat-chip color="accent" selected> Orden recomendado </mat-chip>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="seccion-content">
        <div class="cronograma-timeline">
          <div
            *ngFor="let documento of documentosLegales; let i = index"
            class="timeline-item"
            [ngClass]="'timeline-' + documento.estado"
          >
            <div class="timeline-marker">
              <div
                class="marker-circle"
                [ngClass]="'marker-' + documento.estado"
              >
                <mat-icon>{{
                  documento.estado === "generado" ||
                  documento.estado === "firmado"
                    ? "check"
                    : documento.estado === "generando"
                    ? "hourglass_empty"
                    : puedeGenerarDocumento(documento)
                    ? "radio_button_unchecked"
                    : "block"
                }}</mat-icon>
              </div>
              <div
                class="timeline-line"
                *ngIf="i < documentosLegales.length - 1"
              ></div>
            </div>

            <div class="timeline-content">
              <div class="timeline-header">
                <h4>{{ documento.nombre }}</h4>
                <mat-chip
                  [color]="obtenerColorEstado(documento.estado)"
                  selected
                >
                  {{ documento.estado | titlecase }}
                </mat-chip>
              </div>

              <p class="timeline-descripcion">{{ documento.descripcion }}</p>

              <div class="timeline-meta">
                <span *ngIf="documento.fechaGeneracion" class="meta-item">
                  <mat-icon>schedule</mat-icon>
                  {{ formatearFecha(documento.fechaGeneracion) }}
                </span>

                <span
                  *ngIf="documento.esObligatorio"
                  class="meta-item obligatorio"
                >
                  <mat-icon>star</mat-icon>
                  Obligatorio
                </span>

                <span
                  *ngIf="
                    !puedeGenerarDocumento(documento) &&
                    documento.estado === 'pendiente'
                  "
                  class="meta-item bloqueado"
                >
                  <mat-icon>lock</mat-icon>
                  Bloqueado por dependencias
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Sección: Historial de Acciones -->
    <mat-expansion-panel
      [expanded]="estaSeccionExpandida('historial')"
      (opened)="expandirSeccion('historial')"
    >
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon color="primary">history</mat-icon>
          <span class="ml-2">Historial de Acciones</span>
        </mat-panel-title>
        <mat-panel-description>
          <mat-chip color="primary" selected>
            {{ historialDocumentos.length }} eventos
          </mat-chip>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="seccion-content">
        <div class="historial-lista">
          <div
            *ngFor="let evento of historialDocumentos"
            class="historial-item"
          >
            <div class="evento-fecha">
              {{ evento.fecha.toLocaleString("es-PE") }}
            </div>
            <div class="evento-contenido">
              <div class="evento-accion">
                <mat-icon color="primary">event</mat-icon>
                <span>{{ evento.accion }}</span>
              </div>
              <div class="evento-usuario">Por: {{ evento.usuario }}</div>
              <div class="evento-observaciones" *ngIf="evento.observaciones">
                {{ evento.observaciones }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </div>

  <!-- ========================================== -->
  <!-- VISTA PREVIA DE DOCUMENTO -->
  <!-- ========================================== -->
  <div
    class="vista-previa-overlay"
    *ngIf="mostrarVistaPrevia"
    (click)="cerrarVistaPrevia()"
  >
    <div class="vista-previa-container" (click)="$event.stopPropagation()">
      <mat-card class="vista-previa-card">
        <mat-card-header>
          <mat-card-title
            class="d-flex justify-content-between align-items-center w-100"
          >
            <span>{{ documentoSeleccionado?.nombre }}</span>
            <button mat-icon-button (click)="cerrarVistaPrevia()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="vista-previa-content">
          <div class="documento-preview">
            <iframe
              [src]="documentoSeleccionado?.urlDocumento"
              width="100%"
              height="600px"
              frameborder="0"
            >
            </iframe>
          </div>
        </mat-card-content>

        <mat-card-actions align="end">
          <button mat-button (click)="cerrarVistaPrevia()">Cerrar</button>
          <button
            mat-raised-button
            color="primary"
            (click)="descargarDocumento(documentoSeleccionado!)"
          >
            <mat-icon>download</mat-icon>
            Descargar
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>
