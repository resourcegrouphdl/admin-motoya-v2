   <h2 mat-dialog-title>Crear Nuevo Usuario</h2>
    
    <mat-dialog-content>
      <mat-stepper [linear]="true" #stepper>
        
        <!-- Step 1: Seleccionar tipo de usuario -->
        <mat-step [stepControl]="userTypeForm" label="Tipo de Usuario">
          <form [formGroup]="userTypeForm">
            <mat-form-field appearance="outline">
              <mat-label>Tipo de Usuario</mat-label>
              <mat-select formControlName="userType" (selectionChange)="onUserTypeChange($event.value)">
                <mat-option *ngFor="let type of userTypes" [value]="type.value">
                  <div>
                    <div>{{ type.label }}</div>
                    <div style="font-size: 12px; color: #666;">{{ type.description }}</div>
                  </div>
                </mat-option>
              </mat-select>
              <mat-error *ngIf="userTypeForm.get('userType')?.hasError('required')">
                Seleccione un tipo de usuario
              </mat-error>
            </mat-form-field>
            
            <div>
              <button mat-button matStepperNext [disabled]="!userTypeForm.valid">Siguiente</button>
            </div>
          </form>
        </mat-step>

        <!-- Step 2: Datos básicos -->
        <mat-step [stepControl]="basicDataForm" label="Datos Básicos">
          <form [formGroup]="basicDataForm">
            
            <mat-form-field appearance="outline">
              <mat-label>Nombres</mat-label>
              <input matInput formControlName="firstName">
              <mat-error *ngIf="basicDataForm.get('firstName')?.hasError('required')">
                Nombres es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Apellidos</mat-label>
              <input matInput formControlName="lastName">
              <mat-error *ngIf="basicDataForm.get('lastName')?.hasError('required')">
                Apellidos es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email">
              <mat-error *ngIf="basicDataForm.get('email')?.hasError('required')">
                Email es requerido
              </mat-error>
              <mat-error *ngIf="basicDataForm.get('email')?.hasError('email')">
                Email no válido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Teléfono</mat-label>
              <input matInput formControlName="phone">
              <mat-error *ngIf="basicDataForm.get('phone')?.hasError('required')">
                Teléfono es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Tipo de Documento</mat-label>
              <mat-select formControlName="documentType">
                <mat-option *ngFor="let doc of documentTypes" [value]="doc.value">
                  {{ doc.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="basicDataForm.get('documentType')?.hasError('required')">
                Seleccione tipo de documento
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Número de Documento</mat-label>
              <input matInput formControlName="documentNumber">
              <mat-error *ngIf="basicDataForm.get('documentNumber')?.hasError('required')">
                Número de documento es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Contraseña</mat-label>
              <input matInput type="password" formControlName="password">
              <mat-error *ngIf="basicDataForm.get('password')?.hasError('required')">
                Contraseña es requerida
              </mat-error>
              <mat-error *ngIf="basicDataForm.get('password')?.hasError('minlength')">
                Mínimo 6 caracteres
              </mat-error>
            </mat-form-field>

            <div>
              <button mat-button matStepperPrevious>Anterior</button>
              <button mat-button matStepperNext [disabled]="!basicDataForm.valid">Siguiente</button>
            </div>
          </form>
        </mat-step>

        <!-- Step 3: Permisos específicos -->
        <mat-step [stepControl]="specificDataForm" label="Permisos Específicos">
          <form [formGroup]="specificDataForm">
            <h3>Permisos para {{ getSelectedUserTypeLabel() }}</h3>
            
            <!-- Permisos dinámicos según tipo de usuario -->
            <ng-container [ngSwitch]="selectedUserType">
              
              <!-- Comercial -->
              <div *ngSwitchCase="'comercial'">
                <mat-form-field appearance="outline">
                  <mat-label>Equipo de Ventas</mat-label>
                  <input matInput formControlName="salesTeam">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Meta de Ventas</mat-label>
                  <input matInput type="number" formControlName="salesTarget">
                </mat-form-field>
              </div>

              <!-- Logística -->
              <div *ngSwitchCase="'logistica'">
                <mat-form-field appearance="outline">
                  <mat-label>Nivel de Inventario</mat-label>
                  <mat-select formControlName="inventoryLevel">
                    <mat-option value="basic">Básico</mat-option>
                    <mat-option value="advanced">Avanzado</mat-option>
                    <mat-option value="full">Completo</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Finanzas -->
              <div *ngSwitchCase="'finanzas'">
                <mat-checkbox formControlName="accountingAccess">Acceso a Contabilidad</mat-checkbox>
                <mat-checkbox formControlName="treasuryAccess">Acceso a Tesorería</mat-checkbox>
                <mat-checkbox formControlName="bankAccess">Acceso a Bancos</mat-checkbox>
                <mat-checkbox formControlName="creditAccess">Acceso a Créditos</mat-checkbox>
              </div>

              <!-- Gerencia -->
              <div *ngSwitchCase="'gerencia'">
                <mat-checkbox formControlName="auditAccess">Acceso a Auditoría</mat-checkbox>
                <mat-checkbox formControlName="costsAccess">Acceso a Costos</mat-checkbox>
                <mat-checkbox formControlName="financialStatementsAccess">Acceso a EE.FF.</mat-checkbox>
                <mat-form-field appearance="outline">
                  <mat-label>Nivel de Acceso al Sistema</mat-label>
                  <mat-select formControlName="systemAccessLevel">
                    <mat-option value="restricted">Restringido</mat-option>
                    <mat-option value="full">Completo</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Contabilidad -->
              <div *ngSwitchCase="'contabilidad'">
                <mat-checkbox formControlName="billingAccess">Acceso a Facturación</mat-checkbox>
                <mat-checkbox formControlName="purchaseBooksAccess">Acceso a Libro de Compras</mat-checkbox>
                <mat-checkbox formControlName="salesBooksAccess">Acceso a Libro de Ventas</mat-checkbox>
                <mat-checkbox formControlName="kardexAccess">Acceso a Kardex</mat-checkbox>
                <mat-checkbox formControlName="electronicBooksAccess">Acceso a Libros Electrónicos</mat-checkbox>
              </div>

              <!-- Administración -->
              <div *ngSwitchCase="'administracion'">
                <mat-checkbox formControlName="companyManagement">Gestión de Empresas</mat-checkbox>
                <mat-checkbox formControlName="supplierManagement">Gestión de Proveedores</mat-checkbox>
                <mat-checkbox formControlName="productManagement">Gestión de Productos</mat-checkbox>
                <mat-checkbox formControlName="categoryManagement">Gestión de Categorías</mat-checkbox>
                <mat-checkbox formControlName="priceManagement">Gestión de Precios</mat-checkbox>
              </div>

              <!-- Recursos Humanos -->
              <div *ngSwitchCase="'recursos_humanos'">
                <mat-checkbox formControlName="contractsAccess">Acceso a Contratos</mat-checkbox>
                <mat-checkbox formControlName="personnelControlAccess">Control de Personal</mat-checkbox>
                <mat-checkbox formControlName="trainingAccess">Acceso a Capacitación</mat-checkbox>
                <mat-checkbox formControlName="performanceEvaluationAccess">Evaluación de Desempeño</mat-checkbox>
              </div>

            </ng-container>

            <div>
              <button mat-button matStepperPrevious>Anterior</button>
              <button mat-button matStepperNext>Siguiente</button>
            </div>
          </form>
        </mat-step>

        <!-- Step 4: Confirmación -->
        <mat-step label="Confirmación">
          <div>
            <h3>Resumen del Usuario</h3>
            <p><strong>Tipo:</strong> {{ getSelectedUserTypeLabel() }}</p>
            <p><strong>Nombre:</strong> {{ basicDataForm.get('firstName')?.value }} {{ basicDataForm.get('lastName')?.value }}</p>
            <p><strong>Email:</strong> {{ basicDataForm.get('email')?.value }}</p>
            <p><strong>Teléfono:</strong> {{ basicDataForm.get('phone')?.value }}</p>
            <p><strong>Documento:</strong> {{ basicDataForm.get('documentType')?.value }} - {{ basicDataForm.get('documentNumber')?.value }}</p>
          </div>

          <div>
            <button mat-button matStepperPrevious>Anterior</button>
            <button mat-raised-button color="primary" 
                    (click)="createUser()" 
                    [disabled]="isCreating">
              <mat-spinner diameter="20" *ngIf="isCreating"></mat-spinner>
              {{ isCreating ? 'Creando...' : 'Crear Usuario' }}
            </button>
          </div>
        </mat-step>

      </mat-stepper>
    </mat-dialog-content>

    <mat-dialog-actions>
      <button mat-button (click)="close()">Cancelar</button>
    </mat-dialog-actions>